---
layout: post
mathjax: true
title:  "DNN with backpropagation in C++, part 8"
date:   2021-08-23 00:00:00 +0000
categories: github jekyll
---

## Implementing convolution layer in C++

Convolution is a mathematical operation on two functions f and g that produces a function $$f*g$$

$$
 (f * g)(t) = \int_{-\infty}^{\infty} f(\mathcal{t})g(t-\mathcal{t}) \partial \mathcal{t}
$$

Discrete convolution is an operation on two discrete time signals defined by the sum:

$$
 (f * g)(i) = \sum_{m=-\infty}^{\infty} f(i-m) g(m)
$$

Discrete convolution with filter size M, this can be written as:

$$
 y(i) = \sum_{m=0}^{M-1} f(i-m) g(m)
$$

For 2-D case, discrete convolution h(i,j) is:

$$
 f(i, j) = \sum_{m=0}^{M-1} \sum_{n=0}^{N} f(i-m, j-n) g(m, n)
$$

### Example of discrete 2D convolution of input featue map (light blue) with kernel (dark blue)

Kernel:

![conv_kernel_image]({{ site.url }}/images/kernel1.png)

Convolution:

![conv]({{ site.url }}/images/conv1.png)

Convolution illustration is from "A guide to convolution arithmetic for deep learning", by Vincent Dumoulin, Francesco Visin. arXiv:1603.07285


### Forward path for 1 convolution layer NN

Conv layer neural net output $$\hat Y$$ is:

$$
\hat Y = X * W
$$

where X is input vector of size N:

$$
X = \left( \begin{array}{ccc}
x_{1} & x_{2} & \ldots & x_{N} \\
\end{array} \right)
$$

W is convolution kernel of size M

$$
W = \left( \begin{array}{ccc}
w_{1} & w_{2} & \ldots & x_{M} \\
\end{array} \right)
$$

### Convolution as a matrix multiplication

Convolution operator can be represented as a matrix multiplication $$ X * W $$ , with convolution kernel W converted into [Toeplitz matrix] [toeplitz_matrix]

$$
W = \left( \begin{array}{ccc}
w_{1} & w_{2} & \ldots &  w_{M} &        0 &      0  & \ldots 0\\
    0 & w_{1} &  w_{2} & \ldots &    w_{M} &      0  & \ldots 0\\
    0 &     0 &  w_{1} &  w_{2} &  \ldots  &  w_{M}  & \ldots 0\\
\vdots & \vdots & \ldots & \vdots & \ldots & \ldots  & \ldots \\
    0 &     0 &      0 &      0 &  \ldots  & w_{M}   &  0 \\
    0 &     0 &      0 &      0 &  \ldots  & w_{M-1} &  w_{M} \\
\end{array} \right)
$$

[toeplitz_matrix]: https://en.wikipedia.org/wiki/Toeplitz_matrix


